apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: price-service-hpa
  namespace: trading-system
  labels:
    app: price-service
spec:
  # Target deployment
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: price-service

  # Replica bounds - start with 1, scale to 3 maximum
  minReplicas: 1 # Start with 1 pod
  maxReplicas: 3 # Maximum 3 pods

  # Metrics to monitor
  metrics:
    # Primary metric: CPU utilization
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70 # Scale when avg CPU > 70%

  # Scaling behavior (prevents flapping)
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60 # Wait 30s before scaling up
      policies:
        # Add 1 pod at a time (gradual scaling: 1 → 2 → 3)
        - type: Pods
          value: 1 # Add 1 pod at a time
          periodSeconds: 120 # Every 60 seconds
      selectPolicy: Max

    scaleDown:
      stabilizationWindowSeconds: 300 # Wait 5 minutes before scaling down
      policies:
        # Remove pods gradually when traffic decreases
        - type: Percent
          value: 60 # Remove 50% of pods
          periodSeconds: 60 # Check every 60 seconds
        - type: Pods
          value: 1 # Or remove 1 pod at a time (whichever is smaller)
          periodSeconds: 60
      selectPolicy: Min # Use the policy that removes fewer pods
